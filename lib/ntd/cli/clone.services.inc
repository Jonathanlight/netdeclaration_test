<?php


$facture_ids = array('5978',
                     '5729',
                     '5616',
                     '4919',
                     '5473',
                     '7888',
                     '4692',
                     '4957',
                     '6377',
                     '8657',
                     '5128',
                     '8645',
                     '8480',
                     '6007',
                     '5143',
                     '4143',
                     '7271',
                     '6450',
                     '8418',
                     '4299',
                     '4065',
                     '4965',
                     '5129',
                     '5436',
                     '8143',
                     '4588',
                     '5340',
                     '5230',
                     '6401',
                     '4106',
                     '6710',
                     '8616',
                     '5654',
                     '4305',
                     '5386',
                     '5478',
                     '5115',
                     '5962',
                     '3830',
                     '8286',
                     '5347',
                     '7776',
                     '6159',
                     '5577',
                     '6206',
                     '7431',
                     '7761',
                     '5112',
                     '7246',
                     '5355',
                     '5402',
                     '5380',
                     '7023',
                     '4130',
                     '5883',
                     '5645',
                     '5547',
                     '6709',
                     '5342',
                     '5384',
                     '7445',
                     '3930',
                     '5586',
                     '5874',
                     '6112',
                     '5976',
                     '5417',
                     '4460',
                     '4061',
                     '5541',
                     '3921',
                     '8468',
                     '6820',
                     '5958',
                     '6422',
                     '5510',
                     '4661',
                     '5053',
                     '5164',
                     '7091',
                     '4633',
                     '7385',
                     '8921',
                     '3923',
                     '4403',
                     '7352',
                     '4363',
                     '6118',
                     '8396',
                     '6407',
                     '4543',
                     '4555',
                     '5885',
                     '5886',
                     '8496',
                     '3884',
                     '7803',
                     '7033',
                     '5273',
                     '6393',
                     '6664',
                     '7332',
                     '7487',
                     '8455',
                     '6119',
                     '5368',
                     '4622',
                     '7485',
                     '4879',
                     '7814',
                     '7903',
                     '5516',
                     '4474',
                     '5649',
                     '6089',
                     '5531',
                     '4359',
                     '5719',
                     '7437',
                     '5121',
                     '7207',
                     '7694',
                     '4303',
                     '8939',
                     '7314',
                     '4969',
                     '4324',
                     '7146',
                     '7822',
                     '4504',
                     '8307',
                     '5398',
                     '5146',
                     '5518',
                     '8371',
                     '5309',
                     '4013',
                     '5917',
                     '4369',
                     '5909',
                     '4134',
                     '6694',
                     '5535',
                     '5647',
                     '4014',
                     '4954',
                     '3754',
                     '3888',
                     '5584',
                     '5069',
                     '4026',
                     '6427',
                     '4620',
                     '6400',
                     '7875',
                     '8133',
                     '6061',
                     '6284',
                     '6659',
                     '5530',
                     '5715',
                     '5893',
                     '4833',
                     '8963',
                     '6064',
                     '6797',
                     '4836',
                     '7071',
                     '5734',
                     '3739',
                     '5689',
                     '8754',
                     '6430',
                     '5456',
                     '7376',
                     '3878',
                     '4704',
                     '4297',
                     '8502',
                     '7747',
                     '5201',
                     '6680',
                     '5339',
                     '4325',
                     '5305',
                     '5373',
                     '4840',
                     '5884',
                     '5710',
                     '5657',
                     '5551',
                     '7206',
                     '7901',
                     '6015',
                     '7107',
                     '5914',
                     '8402',
                     '4217',
                     '6223',
                     '5479',
                     '5545',
                     '5620',
                     '6279',
                     '5863',
                     '6416',
                     '7456',
                     '7333',
                     '5182',
                     '8943',
                     '5332',
                     '7438',
                     '7830',
                     '7165',
                     '7284',
                     '8076',
                     '4819',
                     '5335',
                     '4131',
                     '5870',
                     '5876',
                     '4952',
                     '5869',
                     '5632',
                     '5727',
                     '5713',
                     '5814',
                     '7245',
                     '5300',
                     '5325',
                     '5634',
                     '6191',
                     '3935',
                     '5197',
                     '8029',
                     '4837',
                     '5538',
                     '4457',
                     '6346',
                     '3760',
                     '6469',
                     '5754',
                     '4298',
                     '7727',
                     '5219',
                     '5107',
                     '7904',
                     '4252',
                     '4779',
                     '3960',
                     '5895',
                     '6816',
                     '5026',
                     '6235',
                     '8091',
                     '5860',
                     '5643',
                     '8607',
                     '7420',
                     '8911',
                     '5801',
                     '5772',
                     '4730',
                     '6712',
                     '5147',
                     '6332',
                     '6005',
                     '4838',
                     '5281',
                     '5043',
                     '7272',
                     '3828',
                     '5512',
                     '5992',
                     '4296',
                     '3885',
                     '4982',
                     '5686',
                     '7898',
                     '5789',
                     '6667',
                     '6353',
                     '5573',
                     '7170',
                     '4660',
                     '4323',
                     '8255',
                     '4761',
                     '4258',
                     '6052',
                     '5131',
                     '4610',
                     '5977',
                     '7119',
                     '7367',
                     '4322',
                     '5314',
                     '8530',
                     '5396',
                     '5216',
                     '5127',
                     '6209',
                     '5791',
                     '5782',
                     '6269',
                     '4795',
                     '6139',
                     '7817',
                     '7077',
                     '3825',
                     '3826',
                     '5878',
                     '7674',
                     '3943',
                     '4977',
                     '6170',
                     '6281',
                     '4616',
                     '5051',
                     '4624',
                     '4987',
                     '4136',
                     '4910',
                     '5668',
                     '3925',
                     '4786',
                     '6275',
                     '6204',
                     '4046',
                     '8736',
                     '5737',
                     '5407',
                     '6425',
                     '5484',
                     '5735',
                     '7635',
                     '5707',
                     '6423',
                     '5387',
                     '4015',
                     '4179',
                     '4780',
                     '4774',
                     '5938',
                     '7684',
                     '7018',
                     '5400',
                     '7458',
                     '7139',
                     '7670',
                     '6564',
                     '4763',
                     '3932',
                     '8284',
                     '5226',
                     '5674',
                     '3928',
                     '5251',
                     '6043',
                     '5773',
                     '7700',
                     '4627',
                     '5803',
                     '4301',
                     '4821',
                     '4922',
                     '5457',
                     '8572',
                     '5280',
                     '4612',
                     '5771',
                     '5126',
                     '7632',
                     '3842',
                     '4941',
                     '7473',
                     '7118',
                     '4632',
                     '5066',
                     '4747',
                     '4452',
                     '4021',
                     '4895',
                     '7430',
                     '8026',
                     '5800',
                     '7857',
                     '6244',
                     '7720',
                     '7103',
                     '5068',
                     '7028',
                     '8734',
                     '6026',
                     '4963',
                     '6719',
                     '6278',
                     '8539',
                     '8779',
                     '5046',
                     '7840',
                     '5144',
                     '5061',
                     '5785',
                     '8894',
                     '8546',
                     '5619',
                     '8492',
                     '7707',
                     '6339',
                     '8088',
                     '6055',
                     '7073',
                     '5526',
                     '4968',
                     '8108',
                     '5837',
                     '6222',
                     '4997',
                     '4396',
                     '5996',
                     '4048',
                     '7767',
                     '4667',
                     '7859',
                     '4135',
                     '8144',
                     '4304',
                     '7042',
                     '6050',
                     '4688',
                     '5571',
                     '7686',
                     '4443',
                     '7120',
                     '4744',
                     '8889',
                     '5001',
                     '8494',
                     '7270',
                     '5492',
                     '5349',
                     '4166',
                     '3742',
                     '5256',
                     '7908',
                     '6388',
                     '5188',
                     '4439',
                     '8220',
                     '5856',
                     '6560',
                     '5658',
                     '6382',
                     '6242',
                     '6599',
                     '5157',
                     '6753',
                     '3887',
                     '7338',
                     '8770',
                     '3936',
                     '6081',
                     '5432',
                     '6234',
                     '5935',
                     '6762',
                     '5341',
                     '5192',
                     '5922',
                     '4578',
                     '5263',
                     '7408',
                     '6117',
                     '4302',
                     '7427',
                     '4709',
                     '4741',
                     '5050',
                     '4927',
                     '6708',
                     '8306',
                     '5638',
                     '8458',
                     '7846',
                     '6063',
                     '7669',
                     '6200',
                     '3744',
                     '6214',
                     '8824',
                     '6029',
                     '5434',
                     '5818',
                     '8123',
                     '7399',
                     '4964',
                     '4846',
                     '6443',
                     '5519',
                     '5217',
                     '6096',
                     '3944',
                     '4906',
                     '7105',
                     '6711',
                     '4754',
                     '6674',
                     '7373',
                     '5241',
                     '7698',
                     '7112',
                     '4975',
                     '3950',
                     '8285',
                     '7691',
                     '4881',
                     '7790',
                     '8773',
                     '5437',
                     '7334',
                     '4998',
                     '5964',
                     '5494',
                     '8400',
                     '4999',
                     '7746',
                     '6008',
                     '5987',
                     '7154',
                     '5142',
                     '4894',
                     '4769',
                     '6141',
                     '7881',
                     '6035',
                     '4538',
                     '6329',
                     '8073',
                     '8603',
                     '4250',
                     '8326',
                     '6307',
                     '5375',
                     '5070',
                     '5723',
                     '4794',
                     '4145',
                     '5892',
                     '8361',
                     '5665',
                     '5799',
                     '8269',
                     '5695',
                     '4914',
                     '5460',
                     '6673',
                     '4328',
                     '5403',
                     '5899',
                     '6801',
                     '6076',
                     '6097',
                     '5774',
                     '5412',
                     '6823',
                     '6162',
                     '7025',
                     '7905',
                     '5947',
                     '5716',
                     '5322',
                     '5983',
                     '4218',
                     '6311',
                     '5797',
                     '7217',
                     '6390',
                     '6136',
                     '5439',
                     '7676',
                     '7043',
                     '4707',
                     '7036',
                     '5363',
                     '8839',
                     '4531',
                     '5919',
                     '7472',
                     '5220',
                     '7447',
                     '7722',
                     '7348',
                     '5796',
                     '6428',
                     '5777',
                     '6193',
                     '4936',
                     '5975',
                     '8461',
                     '7883',
                     '6385',
                     '7808',
                     '4501',
                     '6059',
                     '6147',
                     '6476',
                     '7384',
                     '7475',
                     '9023',
                     '6706',
                     '7647',
                     '5039',
                     '5312',
                     '4456',
                     '5904',
                     '8058',
                     '6589',
                     '4940',
                     '4373',
                     '6349',
                     '8602',
                     '7261',
                     '4565',
                     '3835',
                     '6172',
                     '4992',
                     '4935',
                     '5117',
                     '5200',
                     '4142',
                     '6197',
                     '6168',
                     '5318',
                     '5486',
                     '6663',
                     '5393',
                     '4972',
                     '5199',
                     '7031',
                     '4476',
                     '5543',
                     '6679',
                     '7260',
                     '5524',
                     '6728',
                     '6704',
                     '5991',
                     '7705',
                     '6669',
                     '4814',
                     '8271',
                     '8640',
                     '5408',
                     '3770',
                     '8005',
                     '7668',
                     '4662',
                     '6399',
                     '8722',
                     '4684',
                     '5631',
                     '7885',
                     '7786',
                     '7321',
                     '5511',
                     '6619',
                     '7355',
                     '8287',
                     '5470',
                     '5661',
                     '7407',
                     '5321',
                     '4645',
                     '5905',
                     '4547',
                     '8336',
                     '6103',
                     '4928',
                     '8444',
                     '6078',
                     '8068',
                     '6018',
                     '5910',
                     '8359',
                     '6306',
                     '6251',
                     '3952',
                     '8224',
                     '7902',
                     '5179',
                     '5809',
                     '6270',
                     '5903',
                     '3981',
                     '8427',
                     '5030',
                     '5021',
                     '5371',
                     '4711',
                     '6391',
                     '7818',
                     '5646',
                     '7832',
                     '5709',
                     '8866',
                     '5116',
                     '5496',
                     '7403',
                     '5618',
                     '4086',
                     '6036',
                     '7988',
                     '8074',
                     '4810',
                     '5118',
                     '8563',
                     '8619',
                     '5667',
                     '6392',
                     '5266',
                     '8067',
                     '3945',
                     '4330',
                     '4693',
                     '5606',
                     '7788',
                     '7394',
                     '6261',
                     '4287',
                     '5062',
                     '4958',
                     '5924',
                     '8746',
                     '8217',
                     '7343',
                     '5937',
                     '7732',
                     '3927',
                     '5394',
                     '4477',
                     '5941',
                     '7328',
                     '4129',
                     '7255',
                     '4989',
                     '5323',
                     '8272',
                     '6815',
                     '5871',
                     '4831',
                     '4740',
                     '4694',
                     '6689',
                     '7462',
                     '7315',
                     '5990',
                     '5829',
                     '4196',
                     '5148',
                     '5815',
                     '6199',
                     '6354',
                     '5523',
                     '6309',
                     '7021',
                     '3755',
                     '5488',
                     '8327',
                     '7651',
                     '5704',
                     '5172',
                     '5517',
                     '4509',
                     '6132',
                     '3899',
                     '6000',
                     '6713',
                     '5158',
                     '4976',
                     '6355',
                     '7100',
                     '3829',
                     '6164',
                     '4454',
                     '7744',
                     '4817',
                     '4625',
                     '6239',
                     '4967',
                     '6024',
                     '8160',
                     '8055',
                     '6082',
                     '6798',
                     '8505',
                     '8139',
                     '8416',
                     '5024',
                     '8604',
                     '7382',
                     '5385',
                     '5397',
                     '5844',
                     '6345',
                     '5986',
                     '6766',
                     '6273',
                     '5862',
                     '5234',
                     '5806',
                     '3870',
                     '4809',
                     '7899',
                     '8986',
                     '8606',
                     '7063',
                     '4736',
                     '4115',
                     '7257',
                     '7405',
                     '5621',
                     '5891',
                     '7828',
                     '5169',
                     '8376'

);


try {

  //$csv = new CsvReader('mon.csv', array());

  define('SERVICE_LIASSE_NAME', 'E-Liasse');
  $service_liasse = Service::getInstance(array('name' => SERVICE_LIASSE_NAME));
  $service_acces_liasse = $service_liasse->getService(); //Service::getInstance(SERVICE_LIASSE_ACCES_ID);

  $souscriptions_created = array();
  foreach ($facture_ids as $facture_id) {

    try {
      $facture = Facture::getInstance($facture_id);
      if ($facture->status != Facture::STATUS_PAYE) {
        S('log')->trace('Facture [' . $facture_id . '] non payée', __FILE__);
        continue;
      }

      $souscription_original = $facture->getSouscriptions()->first();

      if ($souscription_original->status != Souscription::STATUS_ACTIVE) {
        S('log')->trace('souscription [' . $souscription_original->getId() . '] non active', __FILE__);
        continue;
      }
      $adherent = $souscription_original->getAdherent();


      $main_adherent = $adherent->adherent_id > 0 ? $adherent->getAdherent() : $adherent;
      if (Souscription::exists(array('adherent_id' => $adherent->getId(),
                                     'service_id' => $service_liasse->getId(),
                                     'status' => Souscription::STATUS_ACTIVE))) {
        S('log')->trace('souscription liasse deja existante', __FILE__);
        continue;
      }

      $tarif_unitaire = $service_liasse->getTarif($main_adherent, Tarif::PRICE_TYPE_UNITAIRE, 1); // $tarif_siret pour avoir le bon langage
      $context = array();
      $context['prix_unitaire'] = $tarif_unitaire->price;
      $context['quantity'] = 1;
      $context['qty_min'] = $tarif_unitaire->qty_min;
      $context['qty_max'] = $tarif_unitaire->qty_max;
      $context['price_type'] = $tarif_unitaire->price_type;
      $context['price_ht'] = 1 * $tarif_unitaire->price;
      $context['generate_by'] = 'script';

      $souscription = Souscription::getInstance();
      $souscription->commit(array('adherent_id' => $adherent->getId(),
                                  'service_id' => $service_liasse->getId(),
                                  'context' => $context,
                                  'sign_at' => Date::today(),
                                  'start_at' => $souscription_original->start_at,
                                  'finish_at' => $souscription_original->finish_at,
                                  'status' => Souscription::STATUS_ACTIVE,
                                  'price' => $context['price_ht'],
                                  'is_renewable' => 1));
      $souscriptions_created[$service_liasse->getId()]++;
      S('log')->trace('Creation Souscription E-liasse [' . $souscription->getId() . ']');

      $souscription_original->setAttribute('is_renewable', 0);

      $opts = array('filters' => array('service_id' => $service_acces_liasse->getId(),
                                       array(
                                         array('|IN|status' => array(Souscription::STATUS_ACTIVE, Souscription::STATUS_CANCELLING_ASKED),
                                               '|<=|start_at' => Date::today(),
                                               '|>=|finish_at' => Date::today()),
                                         array('OR' => array('status' => Souscription::STATUS_WAITING_PAIEMENT))
                                       )));
      $main_adherent_souscription = $main_adherent->getSouscriptions($opts);
      if ($main_adherent_souscription->count() < 1) {
        $required_tarif_forfait = $service_acces_liasse->getTarif($main_adherent, Tarif::PRICE_TYPE_FORFAIT);

        $context = Souscription::getSouscriptionContext($service_acces_liasse,
                                                        $main_adherent,
                                                        array('quantity' => 1));
        $record = array('adherent_id' => $main_adherent->getId(),
                        'service_id' => $service_acces_liasse->getId(),
                        'sign_at' => Date::today(), 
                        'start_at' => $souscription_original->start_at,
                        'finish_at' => $souscription_original->finish_at,
                        'status' => Souscription::STATUS_ACTIVE,
                        'context' => $context,
                        'price' => $context['price_ht']);
        $souscription = Souscription::getInstance();
        $souscription->commit($record);
        $souscriptions_created[$service_acces_liasse->getId()]++;
        S('log')->trace('Creation Souscription Accès E-liasse [' . $souscription->getId() . ']');
      }



    }
    catch (Exception $e) {
      print $e->getMessage();
      S('log')->error($e);
    }
  }

  S('log')->trace('Creation Souscriptions Résumé [' . var_export($souscriptions_created, true) . ']');
  var_export($souscriptions_created);


}
catch (Exception $e) {
  print $e->getMessage();
}
